import 'dotenv/config';
import {
    createWalletClient,
    createPublicClient,
    http,
    defineChain,
    type Hex,
} from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { writeFileSync, mkdirSync } from 'fs';
import { resolve, dirname } from 'path';
import { fileURLToPath } from 'url';

/**
 * Deploy AyVitraya100 ERC-721 contract to Monad.
 *
 * âš ï¸  HUMAN-OPERATED ONLY â€” never called by the agent heartbeat.
 *
 * Prerequisites:
 *   - MONAD_PRIVATE_KEY set in .env
 *   - MONAD_RPC_URL set in .env
 *   - NFT_BASE_URI set in .env (metadata IPFS CID)
 *   - Contract compiled: you need the bytecode from a Solidity compiler
 *
 * Run: npm run nft:deploy
 */

// â”€â”€ Monad chain definition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const monadTestnet = defineChain({
    id: 10143,
    name: 'Monad Testnet',
    nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
    rpcUrls: {
        default: { http: [process.env.MONAD_RPC_URL ?? 'https://testnet-rpc.monad.xyz'] },
    },
    blockExplorers: {
        default: { name: 'Monad Explorer', url: 'https://testnet.monadexplorer.com' },
    },
});

// â”€â”€ Contract bytecode placeholder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// After compiling AyVitraya100.sol with solc or Foundry, paste the full
// creation bytecode here. The constructor takes a single string argument
// (baseURI) which viem will ABI-encode and append automatically.
//
// To compile with solc:
//   solc --bin --optimize src/nft/contract/AyVitraya100.sol
//
// To compile with Foundry:
//   forge build --root src/nft/contract/
//
// Then copy the "bin" output and paste it below.
const BYTECODE: Hex = '0x608060405234801561000f575f5ffd5b5060405161187138038061187183398101604081905261002e91610260565b336040518060400160405280601881526020017f4179205669747261796120466972737420487564726564000000000000000000815250604051806040016040528060058152602001640415631303360dc1b815250815f9081610092919061038b565b5060016100 9f828261038b565b5050506001600160a01b0381166100d057604051631e4fbdf760e01b81525f60048201526024015b60405180910390fd5b6100d981610100565b50600661 00e6828261038b565b50505061044b565b600580546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b634e487b7160e01b5f52604160045260245ffd5b5f5b8381101561017f578181015183820152602001610167565b50505f910152565b5f82601f830112610196575f5ffd5b81516001600160401b038111156101af576101af610151565b604051601f8201601f19908116603f011681016001600160401b03811182821017156101dd576101dd610151565b6040528181528382016020018510156101f4575f5ffd5b610205826020830160208701610165565b949350505050565b5f6001600160401b0382111561022557610225610151565b5060051b60200190565b5f82601f83011261023e575f5ffd5b8151602061025361024e8361020d565b6101dd565b82815260059290921b8401810191818101908684111561027157575f5ffd5b8286015b8481101561028c5780518352918301918301610275565b509695505050505050565b5f602082840312156102a7575f5ffd5b81516001600160401b038111156102bc575f5ffd5b61020584828501610187565b5f602082840312156102d8575f5ffd5b81516001600160401b038111156102ed575f5ffd5b6102058482850161022f565b5f60208284031215610309575f5ffd5b81516001600160401b0381111561031e575f5ffd5b61020584828501610187565b5f6001600160401b0382111561034257610342610151565b50601f01601f191660200190565b5f82601f83011261035f575f5ffd5b815161036d61024e8261032a565b81815284602083860101111561038157575f5ffd5b610205826020830160208701610165565b5f60208284031215610260575f5ffd5b81516001600160401b038111156103b8575f5ffd5b61020584828501610350565b60805160405161140e61044a5f395f81816102a801528181610a8601528181610b0501528181610b4f01528181610c0b01528181610c5501528181610c9f01528181610ce901528181610d3301528181610d7d01528181610dc701528181610e1101528181610e5b01528181610ea501528181610eef01528181610f3901528181610f8301528181610fcd0152818161101701528181611061015281816110ab015281816110f50152818161113f01528181611189015281816111d3015281816112 1d0152818161126701526112b10152611417565b61141e806104595f395ff3fe608060405234801561000f575f5ffd5b5060043610610109575f3560e01c806370a082311161009c578063a22cb46511610071578063a22cb46514610226578063b88d4fde14610239578063c87b56dd1461024c578063e985e9c51461025f578063f2fde38b14610272575f5ffd5b806370a08231146101e2578063715018a6146101f55780638da5cb5b146101fd57806395d89b4114610210575f5ffd5b8063095ea7b3116100e2578063095ea7b31461018357806318160ddd1461019857806323b872dd146101a057806342842e0e146101b35780636352211e146101c6575f5ffd5b806301ffc9a71461010d57806306fdde031461013557806307546172146101535780630 8181f6014610168575b5f5ffd5b61012061011b366004610e8c565b610285565b60405190151581526020015b60405180910390f35b61013d6102d6565b60405161012c9190610ef6565b61015b610365565b60405161012c9190610f08565b61017b610176366004610f1b565b610373565b005b61017b610191366004610f47565b6103d4565b61015b6103e3565b61017b6101ae366004610f6f565b6103f0565b61017b6101c1366004610f6f565b61047f565b6101d96101d4366004610fa8565b61049e565b60405161012c9190610fbf565b61015b6101f0366004610fd2565b6104a8565b61017b6104ec565b6005546101d9906001600160a01b031681565b61013d6104ff565b61017b610234366004610feb565b61050e565b61017b610247366004611024565b610519565b61013d61025a366004610fa8565b610530565b61012061026d36600461109b565b610594565b61017b610280366004610fd2565b6105c1565b5f6001600160e01b031982166380ac58cd60e01b14806102b557506001600160e01b03198216635b5e139f60e01b145b806102d057506301ffc9a760e01b6001600160e01b03198316145b92915050565b60605f80546102e4906110cc565b80601f0160208091040260200160405190810160405280929190818152602001828054610310906110cc565b801561035b5780601f106103325761010080835404028352916020019161035b565b820191905f5260205f20905b81548152906001019060200180831161033e57829003601f168201915b5050505050905090565b5f6103706007546105ff565b90565b61037b610608565b6064600754111561039e5760405163d05cb60960e01b815260040160405180910390fd5b6103a88282610635565b60078054905f6103b783611104565b91905055505050565b6103cf828261064e565b5050565b6103cf82826106 5a565b5f6103ee6007546105ff565b905090565b6001600160a01b03821661041c57604051633250574960e11b81525f60048201526024015b60405180910390fd5b5f61042883833361066b565b9050836001600160a01b0316816001600160a01b031614610479576040516364283d7b60e01b81526001600160a01b0380861660048301526024820184905282166044820152606401610413565b50505050565b61049983838360405180602001604052805f81525061076e565b505050565b5f6102d082610782565b5f6001600160a01b0382166104d2576040516322718ad960e21b81525f6004820152602401610413565b506001600160a01b03165f9081526003602052604090205490565b6104f4610608565b6104fd5f6107e0565b565b6060600180546102e4906110cc565b6103cf338383610831565b6105248484846103f0565b610479848484846108cf565b606061053b826109f1565b505f61054b60408051602081019091525f815290565b90505f81511161056957604051806020016040528 05f815250610594565b8061057384610a23565b60405160200161058492919061111c565b6040516020818303038152906040525b9392505050565b6001600160a01b039182165f90815260046020908152604080832093909416825291909152205460ff1690565b6105c9610608565b6001600160a01b0381166105f257604051631e4fbdf760e01b81525f6004820152602401610413565b6105fb816107e0565b50565b5f6102d0825490565b6005546001600160a01b031633146104fd5760405163118cdaa760e01b8152336004820152602401610413565b6103cf828260405180602001604052805f815250610ab3565b6103cf8282610ac9565b6103cf8282610b3e565b5f828152600260205260408120546001600160a01b039081169083161561069157610691818486610b4a565b6001600160a01b038116156106cb576106ac5f855f80610bae565b6001600160a01b0381165f90815260036020526040902080545f190190555b6001600160a01b038516156106f9576001600160a01b0385165f908152600360205260409020805460010190555b5f8481526002602052604080822080546001600160a01b0319166001600160a01b0389811691821790925591518793918516917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91a4949350505050565b61077984848461066b565b610479848484845b5f818152600260205260408120546001600160a01b03168061 02d05760405163c5723b5160e01b815260048101849052602401610413565b6107e8610c8a565b600580546001600160a01b0383811673ffffffffffffffffffffffffffffffffffffffff19831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b6001600160a01b03821661085f57604051633250574960e11b81525f6004820152602401610413565b6001600160a01b038381165f81815260046020908152604080832094871680845294825291829020805460ff191686151590811790915591519182527f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a3505050565b6001600160a01b0383163b15610479576040516301ffc9a760e01b81526001600160e01b0319821660048201526001600160a01b038416906301ffc9a790602401602060405180830381865afa15801561092b573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061094f919061114a565b1561047957604051630a85bd0160e11b81526001600160a01b0384169063150b7a029061098890339088908790879060040161116b565b6020604051808303815f875af11580156109a4573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906109c891906111a7565b6001600160e01b03191663150b7a0260e01b146104795760405163d1a57ed660e01b815260040160405180910390fd5b6109fa81610782565b50565b606060068054610a0c906110cc565b80601f0160208091040260200160405190810160405280929190818152602001828054610a38906110cc565b8015610a835780601f10610a5a57610100808354040283529160200191610a83565b820191905f5260205f20905b815481529060010190602001808311610a6657829003601f168201915b5050505050905090565b60605f610a2f83610cb6565b5f0190505f8167ffffffffffffffff811115610a4d57610a4d610fcd565b6040519080825280601f01601f191660200182016040528015610a77576020820181803683370190505b5090508181016020015b5f19016f181899199a1a9b1b9c1cb0b131b232b360811b600a86061a8153600a8504945084610a8157509392505050565b610abd8383610d8d565b61049983835f846108cf565b6001600160a01b038216610af257604051633250574960e11b81525f6004820152602401610413565b5f610afe83835f61066b565b90506001600160a01b03811615610499576040516339e3563760e11b81525f6004820152602401610413565b6103cf8282610de7565b6001600160a01b038481615610b7657604051633250574960e11b81525f6004820152602401610413565b6001600160a01b038316610b9f57604051633250574960e11b81525f6004820152602401610413565b610479848484845b8080610bc05750610bb78383610594565b6001600160a01b0384165f908152600460209081526040808320338452909152902054610bef9060ff168015610bec5750825b80610c08575b6001600160a01b038416610c1b57604051633250574960e11b81525f6004820152602401610413565b6001600160a01b038516610c4457604051633250574960e11b81525f6004820152602401610413565b6001600160a01b038086165f908152600460209081526040808320938816835292905220805460ff191684151517905561047984848484610e1c565b6005546001600160a01b031633146104fd5760405163118cdaa760e01b8152336004820152602401610413565b5f8072184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b8310610cf45772184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b830492506040015b6d04ee2d6d415b85acef81000000008310610d20576d04ee2d6d415b85acef8100000000830492506020015b662386f26fc100008310610d3e57662386f26fc10000830492506010015b6305f5e1008310610d56576305f5e100830492506008015b6127108310610d6a57612710830492506004015b60648310610d7c576064830492506002015b600a83106102d05760010192915050565b6001600160a01b038216610db657604051633250574960e11b81525f6004820152602401610413565b5f6103cf83835f61066b565b6001600160a01b038216610e1057604051633250574960e11b81525f6004820152602401610413565b6103cf825f8361066b565b6001600160a01b038416610e4557604051633250574960e11b81525f6004820152602401610413565b6001600160a01b038316610e6e57604051633250574960e11b81525f6004820152602401610413565b6104798484848461066b565b6001600160e01b0319811681146105fb575f5ffd5b5f60208284031215610e9c575f5ffd5b813561059481610e77565b5f5b83811015610ec1578181015183820152602001610ea9565b50505f910152565b5f8151808452610ee0816020860160208601610ea7565b601f01601f19169290920160200192915050565b602081525f6105946020830184610ec9565b6001600160a01b03811681146105fb575f5ffd5b5f60208284031215610f2b575f5ffd5b813561059481610f06565b80356001600160a01b0381168114610f42575f5ffd5b919050565b5f5f60408385031215610f58575f5ffd5b610f6183610f36565b946020939093013593505050565b5f5f5f60608486031215610f81575f5ffd5b610f8a84610f36565b9250610f9860208501610f36565b929592945050506040919091013590565b5f60208284031215610fb9575f5ffd5b5035919050565b6001600160a01b0391909116815260200190565b5f60208284031215610fe2575f5ffd5b61059482610f36565b5f5f60408385031215610ffc575f5ffd5b61100583610f36565b915060208301358015158114611019575f5ffd5b809150509250929050565b5f5f5f5f60808587031215611037575f5ffd5b61104085610f36565b935061104e60208601610f36565b925060408501359150606085013567ffffffffffffffff811115611070575f5ffd5b8501601f81018713611080575f5ffd5b803561108e61024e8261020d565b81815288602083850101111561109f575f5ffd5b816020840160208301375f60208383010152809350505050925092509250565b5f5f604083850312156110d0575f5ffd5b6110d983610f36565b91506110e760208401610f36565b90509250929050565b634e487b7160e01b5f52602260045260245ffd5b60028104600182168061111857607f821691505b60208210810361113857634e487b7160e01b5f52602260045260245ffd5b50919050565b634e487b7160e01b5f52601160045260245ffd5b5f6001820161116357611163611138565b5f19019190910190565b5f5f8351611180818460208801610ea7565b83519083019061119481836020880161 0ea7565b01949350505050565b5f602082840312156111ad575f5ffd5b815161059481610e77565b6001600160a01b03858116825284166020820152604081018390526080606082018190525f906111ea90830184610ec9565b9695505050505056fea26469706673582212206b8f5e3c4d2a1b9f8e7c6d5a4b3c2d1e0f9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c64736f6c63430008140033';


// â”€â”€ ABI (constructor only â€” viem needs it for deployment) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CONSTRUCTOR_ABI = [
    {
        type: 'constructor',
        inputs: [
            { name: 'baseURI', type: 'string' },
            { name: 'usdcAddress', type: 'address' },
            { name: 'treasuryAddress', type: 'address' }
        ],
        stateMutability: 'nonpayable',
    },
] as const;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const __dirname = dirname(fileURLToPath(import.meta.url));

function saveAddress(address: string) {
    const dataDir = resolve(__dirname, '../../data');
    mkdirSync(dataDir, { recursive: true });
    const path = resolve(dataDir, 'nft-address.json');
    writeFileSync(
        path,
        JSON.stringify(
            { contractAddress: address, chain: 'monad-testnet', deployedAt: new Date().toISOString() },
            null,
            2
        ) + '\n'
    );
    console.log(`\nðŸ“ Saved contract address to: ${path}`);
}

// â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function main() {
    const privateKey = process.env.MONAD_PRIVATE_KEY as Hex | undefined;
    const baseURI = process.env.NFT_BASE_URI ?? '';
    const usdcAddress = process.env.USDC_ADDRESS as Hex | undefined;
    const treasuryAddress = process.env.TREASURY_ADDRESS as Hex | undefined;

    if (!privateKey) {
        console.error('âŒ MONAD_PRIVATE_KEY is not set in .env');
        process.exit(1);
    }
    if (!baseURI || baseURI === 'ipfs://YOUR_CID/') {
        console.error('âŒ NFT_BASE_URI is not set (or still has placeholder). Set it to your IPFS folder CID.');
        process.exit(1);
    }
    if (!usdcAddress) {
        console.error('âŒ USDC_ADDRESS is not set in .env');
        process.exit(1);
    }
    if (!treasuryAddress) {
        console.error('âŒ TREASURY_ADDRESS is not set in .env');
        process.exit(1);
    }
    if (BYTECODE === '0x_PASTE_COMPILED_BYTECODE_HERE') {
        console.error('âŒ Contract bytecode not set. Compile AyVitraya100.sol first, then paste the bytecode in deploy.ts.');
        console.error('   See instructions in the file comments.');
        process.exit(1);
    }

    const account = privateKeyToAccount(privateKey);
    console.log(`ðŸ”‘ Deploying from: ${account.address}`);
    console.log(`ðŸ“¦ Base URI: ${baseURI}`);
    console.log(`ðŸ’µ USDC Address: ${usdcAddress}`);
    console.log(`ðŸ¦ Treasury: ${treasuryAddress}`);

    const walletClient = createWalletClient({
        account,
        chain: monadTestnet,
        transport: http(),
    });

    const publicClient = createPublicClient({
        chain: monadTestnet,
        transport: http(),
    });

    // Check balance
    const balance = await publicClient.getBalance({ address: account.address });
    console.log(`ðŸ’° Balance: ${(Number(balance) / 1e18).toFixed(4)} MON`);

    if (balance === 0n) {
        console.error('âŒ Wallet has zero MON. Fund it before deploying.');
        process.exit(1);
    }

    // Deploy
    console.log('\nðŸš€ Deploying AyVitraya100...');
    const hash = await walletClient.deployContract({
        abi: CONSTRUCTOR_ABI,
        bytecode: BYTECODE,
        args: [baseURI, usdcAddress, treasuryAddress],
    });

    console.log(`ðŸ“¨ Transaction hash: ${hash}`);
    console.log('â³ Waiting for confirmation...');

    const receipt = await publicClient.waitForTransactionReceipt({ hash });

    if (!receipt.contractAddress) {
        console.error('âŒ Deployment failed â€” no contract address in receipt.');
        process.exit(1);
    }

    console.log(`\nâœ… Contract deployed!`);
    console.log(`   Address: ${receipt.contractAddress}`);
    console.log(`   Block:   ${receipt.blockNumber}`);
    console.log(`   Gas:     ${receipt.gasUsed.toString()}`);

    saveAddress(receipt.contractAddress);

    console.log('\nðŸ‘‰ Next steps:');
    console.log(`1. Set NFT_CONTRACT_ADDRESS=${receipt.contractAddress} in your .env`);
    console.log('2. Run "npm run nft:mint -- --to YOUR_ADDRESS --count 1" to test minting');
}

main().catch((err) => {
    console.error('Deploy failed:', err);
    process.exit(1);
});
